var __reflect=this&&this.__reflect||function(e,t,n){e.__class__=t,n?n.push(t):n=[t],e.__types__=e.__types__?n.concat(e.__types__):n},__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},GameStartScene=function(e){function t(){var t=e.call(this)||this;return t.skinName="GameStartSceneSkin",t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAdded,t),t}return __extends(t,e),t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},t.prototype.onAdded=function(e){this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoved,this),this.gameIntroduceBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onIntroduce,this),this.gameStartBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onStartGame,this),this.aboutUs.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onAboutUs,this)},t.prototype.onRemoved=function(e){this.hasEventListener(egret.Event.REMOVED_FROM_STAGE)&&this.removeEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoved,this)},t.prototype.onIntroduce=function(e){},t.prototype.onStartGame=function(e){S.ViewManager.getInstance().dispatch(GamePlaygroundScene)},t.prototype.onAboutUs=function(e){},t}(eui.Component);__reflect(GameStartScene.prototype,"GameStartScene");var S;!function(e){var t=function(e){function t(t,n,o){return void 0===n&&(n=!1),void 0===o&&(o=!1),e.call(this,t,n,o)||this}return __extends(t,e),t}(egret.Event);t.ERROR="ERROR",e.HttpEvent=t,__reflect(t.prototype,"S.HttpEvent")}(S||(S={}));var S;!function(e){var t=function(){function e(e,t){void 0===t&&(t=!0),this._isPlaying=!1,this._name=e,this._isEffect=t}return Object.defineProperty(e.prototype,"isEffect",{set:function(e){this._isEffect=e},enumerable:!0,configurable:!0}),e.prototype.init=function(){this.sound=RES.getRes(this._name),!this._isEffect&&this.sound?this.sound.type=egret.Sound.MUSIC:this._isEffect&&this.sound&&(this.sound.type=egret.Sound.EFFECT)},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.play=function(e){void 0===e&&(e=0),this.channel=this.sound.play(0,e),this.channel.addEventListener(egret.Event.SOUND_COMPLETE,this.onSoundCompl,this),this._isPlaying=!0},e.prototype.onSoundCompl=function(){this.channel&&this.channel.removeEventListener(egret.Event.SOUND_COMPLETE,this.onSoundCompl,this),this._isPlaying=!1},e.prototype.stop=function(){this.channel.stop(),this.channel.position=0,this.channel=null},e.prototype.updateVolume=function(e){var t=0;e>=0&&1>=e?t=e:0>e?t=0:e>1&&(t=1),this.channel&&(this.channel.volume=t)},e}();e.AudioPlayer=t,__reflect(t.prototype,"S.AudioPlayer")}(S||(S={}));var S;!function(e){var t=function(t){function n(e,n){void 0===n&&(n=egret.HttpMethod.POST);var o=t.call(this)||this;return o._methodType=egret.HttpMethod.POST,o._responseType=egret.HttpResponseType.TEXT,o._header={"Content-Type":"application/x-www-form-urlencoded"},o._methodType=n,o._url=e,o}return __extends(n,t),Object.defineProperty(n.prototype,"methodType",{get:function(){return this._methodType},set:function(e){this._methodType=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"responseType",{get:function(){return this._responseType},set:function(e){this._responseType=e},enumerable:!0,configurable:!0}),n.prototype.setHeader=function(e,t){this._header[e]=t},n.prototype.init=function(){this._request=new egret.HttpRequest,this._request.responseType=this._responseType,this._request.open(this._url,this._methodType);for(var e=Object.keys(this._header),t=0;t<e.length;t++)this._request.setRequestHeader(e[t],this._header[e[t]]);this._request.addEventListener(egret.Event.COMPLETE,this.onPostComplete,this),this._request.addEventListener(egret.ProgressEvent.PROGRESS,this.onPostProgress,this),this._request.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onPostIOError,this)},n.prototype.sendMsg=function(e){void 0===e&&(e=null),this._request.send(e)},n.prototype.onPostComplete=function(t){var n=t.currentTarget,o=new e.HttpEvent(e.HttpEvent.COMPLETE);o.eventType=e.HttpEvent.COMPLETE,o.data=n.response,this.dispatchEvent(o)},n.prototype.onPostIOError=function(t){var n=new e.HttpEvent(e.HttpEvent.COMPLETE);n.data={error:"error",result:t},n.eventType=e.HttpEvent.ERROR,this.dispatchEvent(n)},n.prototype.onPostProgress=function(e){console.log("post progress : "+Math.floor(100*e.bytesLoaded/e.bytesTotal)+"%")},n}(egret.DisplayObjectContainer);e.Http=t,__reflect(t.prototype,"S.Http")}(S||(S={}));var GamePlayControl=function(){function e(){this.snakeNodes=[],this.distanceLength=35,this.playGroundW=640,this.playGroundH=640,this.currDirection="右",this.directions=["上","右","下","左"],this.nums=[2,4,8],this.row=18,this.col=18,this.positions=[],this.disTime=1e3,this.init()}return e.prototype.start=function(){this.snake.setSide(this.playGroundW,this.playGroundH),this.snake.init(this.snakeHeaderNode,this.distanceLength,this.col),this.snake.init(this.snakeBodyNode,this.distanceLength,this.col),this.startTime=egret.getTimer(),egret.startTick(this.frame,this)},e.prototype.restart=function(){egret.startTick(this.frame,this)},e.prototype.pause=function(){egret.stopTick(this.frame,this)},e.prototype.setSnake=function(e){this.snake=e},e.prototype.setFoods=function(e){this.foodsNode=e},e.prototype.init=function(){this.row=Math.floor(this.playGroundH/this.distanceLength),this.col=Math.floor(this.playGroundW/this.distanceLength);for(var e=0;e<this.col*this.row;e++)this.positions[e]=-1;this.snakeHeaderNode=new NumNode,this.snakeHeaderNode.init(this.distanceLength,this.col),this.snakeHeaderNode.setNum("snakeHeader"),this.snakeHeaderNode.updatePos(1),this.positions[1]=1,this.snakeBodyNode=new NumNode,this.snakeBodyNode.init(this.distanceLength,this.col),this.snakeBodyNode.setNum(2),this.snakeBodyNode.updatePos(0),this.positions[0]=1},e.prototype.createNums=function(){var e=Math.floor(3*Math.random());return this.nums[e]},e.prototype.initNumNode=function(e){this.numNode=e;for(var t=Math.ceil(Math.random()*(this.row*this.col-1)),n=this.positions[t];-1!=n;)t=Math.ceil(Math.random()*(this.row*this.col-1)),n=this.positions[t];return this.numNode.init(this.distanceLength,this.col),this.numNode.setNum(this.createNums()),this.numNode.updatePos(t),this.positions[t]=1,this.numNode},e.prototype.updateDirection=function(e){this.snake.updateDirection(e)},e.prototype.snakeMove=function(){this.snake.keepPreTailPos(),this.snake.move()},e.prototype.isHit=function(){this.snakeHeaderNode=this.snake.getSnakeHeaderNode();for(var e=this.snake.getSnakeBodyHeaderNode(),t=0;t<this.foodsNode.length;t++){var n=this.foodsNode[t];if(this.snakeHeaderNode.getPos()==n.getPos()){if(e.getNum()==n.getNum())e.setNum(2*e.getNum()),this.snake.headerCheck();else{var o=new NumNode;o.init(this.distanceLength,this.col),o.setNum(n.getNum()),o.updatePos(n.getPos()),this.snake.addNumNode(o)}this.initNumNode(n)}}},e.prototype.updatePos=function(e,t){for(var n=0;n<this.positions.length;n++)this.positions[n]=-1;for(var o=0,s=e;o<s.length;o++){var i=s[o];this.positions[i.getPos()]=0}for(var r=0,a=t;r<a.length;r++){var i=a[r];this.positions[i.getPos()]=0}},e.prototype.frame=function(e){var t=e-this.startTime;if(t>this.disTime){if(this.isGameFailed())return egret.stopTick(this.frame,this),console.log("游戏结束"),S.ViewManager.getInstance().dispatch(GameResultFailScene),!1;if(this.snakeMove(),this.isHit(),this.isGameSuccessful())return egret.stopTick(this.frame,this),S.ViewManager.getInstance().dispatch(GameResultSuccessfulScene),!0;this.updatePos(this.snake.getSnakeNodes(),this.foodsNode),this.startTime=e}return!1},e.prototype.isGameFailed=function(){return this.snake.isOutSide()?!0:this.snake.isTouchSelf()?!0:!1},e.prototype.isGameSuccessful=function(){return this.snake.isSuccessful()},e}();__reflect(GamePlayControl.prototype,"GamePlayControl");var AssetAdapter=function(){function e(){}return e.prototype.getAsset=function(e,t,n){function o(o){t.call(n,o,e)}if(RES.hasRes(e)){var s=RES.getRes(e);s?o(s):RES.getResAsync(e,o,this)}else RES.getResByUrl(e,o,this,RES.ResourceItem.TYPE_IMAGE)},e}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var GameResultFailScene=function(e){function t(){var t=e.call(this)||this;return t.skinName="GameResultFailSceneSkin",t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAdded,t),t}return __extends(t,e),t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},t.prototype.onAdded=function(e){this.restart.once(egret.TouchEvent.TOUCH_TAP,this.onRestart,this),this.returnHome.once(egret.TouchEvent.TOUCH_TAP,this.onReturnHome,this)},t.prototype.onRestart=function(e){S.ViewManager.getInstance().dispatch(GamePlaygroundScene)},t.prototype.onReturnHome=function(e){S.ViewManager.getInstance().dispatch(GameStartScene)},t}(eui.Component);__reflect(GameResultFailScene.prototype,"GameResultFailScene");var GameResultSuccessfulScene=function(e){function t(){var t=e.call(this)||this;return t.skinName="GameResultSuccessfulSceneSkin",t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAdded,t),t}return __extends(t,e),t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},t.prototype.onAdded=function(e){this.restart.once(egret.TouchEvent.TOUCH_TAP,this.onRestart,this),this.returnHome.once(egret.TouchEvent.TOUCH_TAP,this.onReturnHome,this)},t.prototype.onRestart=function(e){S.ViewManager.getInstance().dispatch(GameStartScene)},t.prototype.onReturnHome=function(e){S.ViewManager.getInstance().dispatch(GamePlaygroundScene)},t}(eui.Component);__reflect(GameResultSuccessfulScene.prototype,"GameResultSuccessfulScene");var S;!function(e){var t=function(e){function t(t,n,o){return void 0===n&&(n=!1),void 0===o&&(o=!1),e.call(this,t,n,o)||this}return __extends(t,e),t}(egret.Event);t.CHANGE_VIEW="CHANGE_VIEW",e.ViewEvent=t,__reflect(t.prototype,"S.ViewEvent")}(S||(S={}));var NumNode=function(e){function t(){var t=e.call(this)||this;return t.pos=-1,t.numValues=[],t}return __extends(t,e),t.prototype.init=function(e,n){t.distanceLength=e,t.col=n},t.prototype.setNum=function(e){this.numValue=e,this.numBitmap=new egret.Bitmap(RES.getRes(e+"_png")),this.numBitmap.width=this.numBitmap.height=t.distanceLength,this.addChild(this.numBitmap)},t.prototype.getNum=function(){return"number"==typeof this.numValue?this.numValue:-1},t.prototype.getPos=function(){return this.pos},t.prototype.updatePos=function(e){void 0===e&&(e=0),this.pos=e;var n=t.distanceLength*(e%t.col),o=t.distanceLength*Math.floor(e/t.col);this.x=n+2,this.y=o+2,console.log("NumNode, x: ",this.x," y: ",this.y)},t}(egret.Sprite);__reflect(NumNode.prototype,"NumNode");var Snake=function(e){function t(){var t=e.call(this)||this;return t.snakeNodes=[],t.currentDir="右",t}return __extends(t,e),t.prototype.init=function(e,t,n){this.disLength=t,this.snakeNodes.push(e);for(var o=0,s=this.snakeNodes;o<s.length;o++){var i=s[o];this.addChild(i)}},t.prototype.addNumNode=function(e){e.updatePos(this.preTailPos),this.snakeNodes.push(e),this.tailCheck(),this.removeChildren();for(var t=0,n=this.snakeNodes;t<n.length;t++){var o=n[t];this.addChild(o)}},t.prototype.headerCheck=function(){if(!(this.snakeNodes.length<2)){var e=this.getSnakeHeaderNode(),t=[];t.push(e);var n=this.getSnakeBodyHeaderNode();t.push(n);for(var o=2,s=!1,i=2;i<this.snakeNodes.length;i++){var r=this.snakeNodes[i];n.getNum()!=r.getNum()||s?(s=!0,r.updatePos(this.snakeNodes[o].getPos()),t.push(r),o++):n.setNum(2*n.getNum())}this.snakeNodes=t,this.removeChildren();for(var a=0,h=this.snakeNodes;a<h.length;a++){var r=h[a];this.addChild(r)}}},t.prototype.tailCheck=function(){if(!(this.snakeNodes.length<2)){for(var e=this.snakeNodes.length-1,t=this.snakeNodes[e],n=[],o=this.snakeNodes.length-2;o>=0;o--){var s=this.snakeNodes[o];if(s.getNum()!=t.getNum())break;s.setNum(2*s.getNum()),t=s,e--}n=this.snakeNodes.slice(0,e+1),this.snakeNodes=n}},t.prototype.getSnakeHeaderNode=function(){return this.snakeNodes[0]},t.prototype.getSnakeBodyHeaderNode=function(){return this.snakeNodes[1]},t.prototype.getSnakeNodes=function(){return this.snakeNodes},t.prototype.updateDirection=function(e){"上"==this.currentDir&&"下"==e||"右"==this.currentDir&&"左"==e||"左"==this.currentDir&&"右"==e||"下"==this.currentDir&&"上"==e||(this.currentDir=e)},t.prototype.keepPreTailPos=function(){this.preTailPos=this.snakeNodes[this.snakeNodes.length-1].getPos()},t.prototype.move=function(){var e=this.snakeNodes[0],t=e.getPos(),n=this.getNextP(t);e.updatePos(n);for(var o=1;o<this.snakeNodes.length;o++){var s=this.snakeNodes[o],i=s.getPos();s.updatePos(t),t=i}},t.prototype.getNextP=function(e){var t=0;switch(this.currentDir){case"上":t=-NumNode.col;break;case"右":t=1;break;case"下":t=NumNode.col;break;case"左":t=-1}return e+t},t.prototype.setSide=function(e,t){this.outSideW=e,this.outSideH=t},t.prototype.isOutSide=function(){var e=this.snakeNodes[0],t=e.x,n=e.y,o=this.disXY(this.currentDir);return t+o.x+NumNode.distanceLength>this.outSideW||t+o.x<0||n+o.y+NumNode.distanceLength>this.outSideH||n+o.y<0?!0:!1},t.prototype.isTouchSelf=function(){for(var e=this.getNextP(this.snakeNodes[0].getPos()),t=0;t<this.snakeNodes.length;t++)if(this.snakeNodes[t].getPos()==e)return!0;return!1},t.prototype.disXY=function(e){var t={x:0,y:0};switch(e){case"上":t.x=0,t.y=-NumNode.distanceLength;break;case"右":t.x=NumNode.distanceLength,t.y=0;break;case"下":t.x=0,t.y=NumNode.distanceLength;break;case"左":t.x=-NumNode.distanceLength,t.y=0}return t},t.prototype.isSuccessful=function(){for(var e=0;e<this.snakeNodes.length;e++)if(this.snakeNodes[e].getNum()>=2048)return!0;return!1},t}(egret.DisplayObjectContainer);__reflect(Snake.prototype,"Snake");var S;!function(e){var t=function(t){function n(e){void 0===e&&(e=null);var n=t.call(this)||this;return n._root=e,n}return __extends(n,t),Object.defineProperty(n.prototype,"root",{get:function(){return this._root},set:function(e){this._root=e},enumerable:!0,configurable:!0}),n.getInstance=function(){return null==n.instance&&(n.instance=new n),n.instance},n.prototype.start=function(e){this._root.addChild(e),this.onView()},n.prototype.dispatch=function(t){var n=new e.ViewEvent(e.ViewEvent.CHANGE_VIEW);n.nextView=t,this.dispatchEvent(n)},n.prototype.onView=function(){this.addEventListener(e.ViewEvent.CHANGE_VIEW,this.onViewEvent,this)},n.prototype.onViewEvent=function(e){var t=new e.nextView;this._root.removeChildren(),this._root.addChild(t)},n}(egret.DisplayObjectContainer);t.instance=new t,e.ViewManager=t,__reflect(t.prototype,"S.ViewManager")}(S||(S={}));var ThemeAdapter=function(){function e(){}return e.prototype.getTheme=function(e,t,n,o){function s(e){t.call(o,e)}function i(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,i,null),n.call(o))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,i,null),RES.getResByUrl(e,s,this,RES.ResourceItem.TYPE_TEXT)},e}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Main=function(e){function t(){var t=e.apply(this,arguments)||this;return t.isThemeLoadEnd=!1,t.isResourceLoadEnd=!1,t}return __extends(t,e),t.prototype.createChildren=function(){e.prototype.createChildren.call(this);var t=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",t),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},t.prototype.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},t.prototype.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},t.prototype.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},t.prototype.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},t.prototype.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},t.prototype.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},t.prototype.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},t.prototype.startCreateScene=function(){this.viewManager=S.ViewManager.getInstance(),this.viewManager.root=this.stage,this.viewManager.start(new GameStartScene)},t}(eui.UILayer);__reflect(Main.prototype,"Main");var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},t.prototype.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var GamePlaygroundScene=function(e){function t(){var t=e.call(this)||this;return t.currDirec="右",t.currNumNod=[],t.currNumNodeCount=3,t.skinName="GamePlaygroundSceneSkin",t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAdded,t),t}return __extends(t,e),t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},t.prototype.onAdded=function(e){this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoved,this),this.overGameBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onOverGame,this),this.startGameBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onStartGame,this),this.pauseGameBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPauseGame,this),this.leftBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onLeft,this),this.topBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTop,this),this.rightBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onRight,this),this.bottomBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBottom,this),this.snake=new Snake,this.playgroundGroup.addChild(this.snake),this.control=new GamePlayControl,this.control.setSnake(this.snake);for(var t=0;t<this.currNumNodeCount;t++){var n=new NumNode;n=this.control.initNumNode(n),this.playgroundGroup.addChild(n),this.currNumNod.push(n)}this.control.setFoods(this.currNumNod),this.control.start()},t.prototype.onRemoved=function(e){this.hasEventListener(egret.Event.REMOVED_FROM_STAGE)&&this.removeEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoved,this)},t.prototype.onOverGame=function(e){S.ViewManager.getInstance().dispatch(GameResultFailScene)},t.prototype.onStartGame=function(e){this.control.restart()},t.prototype.onPauseGame=function(e){this.control.pause()},t.prototype.onLeft=function(e){this.currDirec="左",this.control.updateDirection(this.currDirec)},t.prototype.onTop=function(e){this.currDirec="上",this.control.updateDirection(this.currDirec)},t.prototype.onRight=function(e){this.currDirec="右",this.control.updateDirection(this.currDirec)},t.prototype.onBottom=function(e){this.currDirec="下",this.control.updateDirection(this.currDirec)},t}(eui.Component);__reflect(GamePlaygroundScene.prototype,"GamePlaygroundScene");